================================================================================
CHAIN CONTROLLER SLACK CALCULATION BUG REPORT
================================================================================
Date: 2025-12-08
Issue: Critical bug in slack calculation causing retrieval failures
Impact: 9 of 28 autoRetrieve tests failing (32% failure rate)

================================================================================
EXECUTIVE SUMMARY
================================================================================

The chain controller's slack calculation has a CRITICAL BUG that reports
slack = 0.00m when the anchor has been dragged off the bottom.

ACTUAL SITUATION:
  - Anchor has lifted off seabed (dragged by wind tension)
  - Anchor is no longer providing holding force
  - Boat can drift freely - no physical restraint
  - TRUE SLACK: Infinite (or undefined) - anchor is not holding!

CONTROLLER REPORTS:
  - Slack: 0.00m (chain tight)
  - Result: Windlass refuses to retrieve (correct response to tight chain)
  - But chain is NOT actually tight - anchor is dragging!

CONSEQUENCE:
  - Windlass stops retrieval and never resumes
  - Motor cannot overcome wind to move boat back to original anchor position
  - Test fails with 58-91% of chain still deployed

================================================================================
ROOT CAUSE
================================================================================

IMPOSSIBLE GEOMETRY DETECTED:

Example from test autoRetrieve_25kn_8m:
  - Anchor depth: 8.0m (vertical)
  - Horizontal distance to anchor: 10.81m
  - Chain deployed: 4.50m
  - Minimum chain needed: √(10.81² + 8²) = 13.45m
  - DEFICIT: 8.95m too short!

ANALYSIS:
  Chain length: 4.50m
  Distance needed: 13.45m

  Even if anchor lifted to surface (0m depth):
    - Minimum chain needed: 10.81m (horizontal distance)
    - Still 6.31m too short!

CONCLUSION:
  The anchor MUST have been dragged off the bottom during retrieval.
  Once anchor lifts, it provides no holding force.
  Boat drifts further away with wind, dragging anchor behind.

================================================================================
SLACK CALCULATION ERROR
================================================================================

The controller calculates slack based on:
  slack = rodeDeployed - distanceToAnchor (approximately)

This assumes anchor stays at original position on seabed.

BUG: When anchor drags/lifts, the calculation becomes invalid:
  - distanceToAnchor increases (boat drifting away)
  - rodeDeployed decreases (windlass retrieving)
  - Both factors make calculated slack MORE NEGATIVE
  - Controller thinks chain is "very tight"
  - Reality: Anchor dragging, no holding force!

CORRECT BEHAVIOR:
  When anchor drags/lifts off bottom:
    - Slack should be INFINITE (or undefined)
    - Anchor provides no restraint
    - Boat is essentially free-floating
    - Windlass SHOULD continue retrieval (bring anchor up)

================================================================================
HOW TO DETECT ANCHOR DRAGGING
================================================================================

DETECTION METHOD 1: Impossible Geometry
  If: distanceToAnchor > rodeDeployed
  Then: Anchor MUST have moved (basic physics)

  Note: Account for depth in calculation:
    minChainNeeded = √(horizontalDistance² + depth²)
    if rodeDeployed < minChainNeeded:
      → Anchor has moved/lifted

DETECTION METHOD 2: Anchor Position Tracking
  - Track anchor GPS position over time
  - If anchor position changes > threshold (e.g., 1 meter)
  - Then: Anchor is dragging

DETECTION METHOD 3: Excessive Tension Duration
  - If slack <= 0 for > 60 seconds continuously
  - AND boat continues moving away from anchor
  - Then: Likely dragging (anchor should have held)

================================================================================
RECOMMENDED FIX
================================================================================

OPTION 1: DETECT IMPOSSIBLE GEOMETRY (Easiest)

  Add check in slack calculation:

  ```
  horizontalDistance = calculateHorizontalDistance(boat, anchor)
  minChainNeeded = sqrt(horizontalDistance² + depth²)

  if (rodeDeployed < minChainNeeded * 0.9):  // 10% margin for catenary
    // Anchor has lifted/dragged - geometry impossible
    slack = INFINITY  // or very large number like 999
    anchorStatus = "DRAGGING"
    return slack

  // Normal slack calculation
  slack = rodeDeployed - distanceFromBoatToAnchor
  return slack
  ```

OPTION 2: TRACK ANCHOR POSITION

  Monitor anchor GPS position:
  - Store initial anchor position when set
  - Calculate anchor movement from original position
  - If movement > 1.0m: set anchorStatus = "DRAGGING"
  - When dragging: report slack as infinite

OPTION 3: TIMEOUT WITH WARNING

  If slack <= 0 for extended period:
  - After 60 seconds: log warning "Possible anchor drag"
  - After 120 seconds: set slack = INFINITY
  - Reason: Real anchor should not allow slack=0 for 2 minutes
  - Either anchor is dragging OR extreme conditions

================================================================================
AFFECTED TEST CASES
================================================================================

All 9 failures show same pattern:

1.  autoRetrieve_1kn_3m   - Slack: 0.00m, Distance: unknown
2.  autoRetrieve_4kn_3m   - Slack: 0.00m, Distance: unknown
3.  autoRetrieve_4kn_5m   - Slack: 0.00m, Distance: unknown
4.  autoRetrieve_18kn_3m  - Slack: 0.00m, Distance: unknown
5.  autoRetrieve_20kn_3m  - Slack: 0.00m, Distance: unknown
6.  autoRetrieve_20kn_5m  - Slack: 0.00m, Distance: unknown
7.  autoRetrieve_25kn_3m  - Slack: 0.00m, Distance: unknown
8.  autoRetrieve_25kn_5m  - Slack: 0.00m, Distance: unknown
9.  autoRetrieve_25kn_8m  - Slack: 0.00m, Distance: 10.81m, Rode: 4.50m ← CONFIRMED

Pattern:
  - Shallow depths (3m, 5m) most affected - 8 of 9 failures
  - High winds (18-25kn) cause most dragging - 6 of 9 failures
  - Boat gets stuck with slack=0 for 449+ seconds
  - Windlass correctly refuses to retrieve tight chain
  - But anchor actually dragging - should report slack=infinite

================================================================================
EXPECTED BEHAVIOR AFTER FIX
================================================================================

Current (broken):
  1. Wind pushes boat away during retrieval
  2. Anchor eventually drags/lifts from tension
  3. Controller reports slack = 0 (tight chain)
  4. Windlass stops and never resumes
  5. TEST FAILS

After fix:
  1. Wind pushes boat away during retrieval
  2. Anchor eventually drags/lifts from tension
  3. Controller DETECTS impossible geometry
  4. Controller reports slack = INFINITY (anchor dragging)
  5. Windlass sees slack > threshold
  6. Windlass RESUMES retrieval (bring anchor up)
  7. Motor helps pull boat back while retrieving
  8. TEST PASSES

Benefits:
  - Retrieval completes successfully in high wind
  - Controller accurately reflects physical reality
  - System more robust in extreme conditions
  - Prevents false "tight chain" indication

================================================================================
TESTING RECOMMENDATIONS
================================================================================

After implementing fix, retest these critical cases:

Priority 1 (currently failing):
  - autoRetrieve_25kn_8m - Nearly succeeded (91%), easiest to verify
  - autoRetrieve_20kn_5m - Representative high wind case
  - autoRetrieve_4kn_3m  - Low wind failure (different cause?)

Priority 2 (ensure no regression):
  - autoRetrieve_8kn_3m  - Currently passing (moderate wind/shallow)
  - autoRetrieve_12kn_8m - Currently passing (moderate wind/deep)

Success criteria:
  - Slack reports > 10m when impossible geometry detected
  - Windlass resumes retrieval when anchor dragging
  - All 9 currently-failing tests should pass

================================================================================
ADDITIONAL NOTES
================================================================================

SIMULATOR CONSTRAINT BUG:
  The physics simulator also has a bug - it allows the boat to move beyond
  the physically possible distance given the rode length. This should be
  fixed in the simulator, BUT the controller fix is more important because:

  1. The controller runs on real hardware (ESP32)
  2. Real anchors CAN drag in extreme conditions
  3. Controller must handle anchor dragging gracefully
  4. This is not just a simulation issue - it's a real-world scenario

REAL-WORLD IMPLICATIONS:
  - In real deployment, anchors DO drag in high winds
  - Controller must detect and handle this condition
  - Reporting slack=0 when anchor dragging is dangerous
  - Operator needs to know "anchor dragging" vs "chain tight"
  - Consider adding explicit "anchor dragging" status flag

FORCE ANALYSIS:
  At 25kn wind:
    - Wind force: ~3,289 N
    - Motor force: ~7,200 N (at 90% throttle)
    - Motor has 219% of wind force (2.2x)

  Motor IS strong enough to overcome wind, BUT:
    - Only if anchor is holding position
    - If anchor dragging, boat drifts downwind faster than motor can recover
    - Once anchor lifts, there's no reference point to pull against

================================================================================
QUESTIONS FOR CONTROLLER TEAM
================================================================================

1. How is slack currently calculated?
   - What formula is used?
   - What inputs does it use (rode, distance, depth)?

2. Does controller track anchor position over time?
   - Is original anchor position stored?
   - Can we detect anchor movement?

3. What is maximum valid slack value?
   - Can we use 999 or similar for "infinite"?
   - Or should we add "dragging" status flag?

4. How frequently is slack recalculated?
   - Per physics tick (50ms)?
   - Less frequently?

5. Can we access:
   - Anchor GPS position (lat/lon)?
   - Boat GPS position (lat/lon)?
   - Water depth?
   - Rode deployed?

================================================================================
CONTACT
================================================================================

Analysis by: Claude Code
Date: 2025-12-08
Session: overnight_tests_20251207_150240

Full analysis documents:
  - ANALYSIS_REPORT.txt (comprehensive test results)
  - SLACK_ANALYSIS.txt (detailed slack investigation)
  - MOTOR_FORCE_ANALYSIS.txt (motor capability analysis)
  - This file: CONTROLLER_SLACK_BUG_REPORT.txt

Test data location:
  validation/data/overnight_tests_20251207_150240/

For questions or clarifications, please refer to the detailed analysis
documents listed above.

================================================================================
END OF REPORT
================================================================================
